<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mandarin Reader üìñ</title>
    <script src="https://unpkg.com/pinyin-pro"></script>
    <style>
        :root { --bg: #fdfaf1; --text: #2c3e50; --accent: #d35400; --highlight: #fae5d3; --card: #ffffff; }
        body.dark { --bg: #1a1a1b; --text: #e1e1e1; --accent: #e67e22; --highlight: #333; --card: #2d2d2e; }

        body { margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); display: flex; height: 100vh; overflow: hidden; transition: 0.3s; }
        
        /* SIDEBAR */
        .sidebar { width: 250px; background: var(--card); border-right: 1px solid #ccc; display: flex; flex-direction: column; }
        .sidebar-header { padding: 15px; border-bottom: 1px solid #eee; font-weight: bold; background: var(--accent); color: white; }
        .story-list { flex: 1; overflow-y: auto; padding: 10px; }
        .story-item { padding: 12px; cursor: pointer; border-radius: 6px; margin-bottom: 5px; border-left: 4px solid transparent; }
        .story-item:hover { background: rgba(0,0,0,0.05); }
        .story-item.active { background: rgba(0,0,0,0.05); border-left-color: var(--accent); font-weight: bold; }
        .controls { padding: 15px; border-top: 1px solid #eee; display: flex; gap: 5px; flex-direction: column; }

        /* READER AREA */
        .reader-container { flex: 1; padding: 40px; overflow-y: auto; position: relative; display: flex; flex-direction: column; align-items: center; }
        .reader-toolbar { position: sticky; top: 0; background: var(--bg); padding: 10px; width: 100%; max-width: 800px; display: flex; gap: 15px; border-bottom: 1px solid #ccc; justify-content: space-between; align-items: center; z-index: 10; opacity: 0.95; }
        
        #content-area { max-width: 800px; width: 100%; margin-top: 20px; line-height: 2.2; font-size: 24px; font-family: "KaiTi", "Ê•∑‰Ωì", serif; }
        
        /* INTERACTIVE CHARACTERS */
        .char-span { cursor: pointer; padding: 2px 4px; border-radius: 4px; transition: 0.2s; position: relative; display: inline-block; text-align: center; min-width: 1em; }
        .char-span:hover { background: var(--accent); color: white; }
        .char-span rt { font-family: sans-serif; font-size: 14px; color: #888; user-select: none; }
        .hide-pinyin rt { opacity: 0; }
        .hide-pinyin .char-span:hover rt { opacity: 1; color: white; } /* Peek on hover */
	margin: 0 2px; 

        /* POPUP */
        #word-popup { position: fixed; background: var(--card); border: 2px solid var(--accent); padding: 20px; border-radius: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); display: none; z-index: 100; width: 300px; }
        
        .btn { padding: 8px 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; color: white; }
        .btn-green { background: #27ae60; } .btn-blue { background: #2980b9; } .btn-orange { background: #f39c12; }
    </style>
</head>
<body>

<div class="sidebar">
    <div class="sidebar-header">üìö Story Library</div>

    <div style="padding:10px; border-bottom:1px solid #eee;">
        <button class="btn btn-blue" onclick="window.location.href='index.html'" style="width:100%; background:#34495e;">üè† Back to Home</button>
    </div>

    <div class="story-list" id="story-list"></div>
    <div class="controls">
        <button class="btn btn-blue" onclick="document.getElementById('file-input').click()">üìÇ Import Stories JSON</button>
        <input type="file" id="file-input" style="display:none" accept=".json" onchange="importStories(event)">
        <button class="btn btn-orange" onclick="toggleTheme()">üåó Toggle Theme</button>
    </div>
</div>

<div class="reader-container">
    <div class="reader-toolbar">
        <h2 id="story-title" style="margin:0">Select a Story</h2>
        <div style="display: flex; gap: 10px;">
            <label><input type="checkbox" id="pinyin-toggle" checked onchange="renderCurrent()"> Show Pinyin</label>
            <button class="btn btn-blue" onclick="speakStory()">üîä Listen</button>
        </div>
    </div>
    <div id="content-area"></div>
    <div id="story-translation" style="max-width: 800px; width: 100%; margin-top: 30px; padding-top: 20px; border-top: 1px solid #ccc; color: #666; font-style: italic; display: none;"></div>
</div>

<!-- WORD POPUP -->
<div id="word-popup">
    <div style="display:flex; justify-content:space-between; align-items:start;">
        <h2 id="pop-char" style="margin:0; font-family:'KaiTi'; font-size: 40px; color: var(--accent);"></h2>
        <button onclick="closePopup()" style="background:none; border:none; font-size:20px; cursor:pointer;">√ó</button>
    </div>
    <p id="pop-pinyin" style="color:#666; font-weight:bold; margin: 5px 0;"></p>
    <div id="pop-def" style="margin: 10px 0;">Loading definition...</div>
    <hr>
    <button id="btn-save" class="btn btn-green" style="width:100%" onclick="saveToMainApp()">‚ûï Save to Library</button>
</div>

<script>
    // --- 1. DATA HANDLING ---
    let stories = JSON.parse(localStorage.getItem('mandarinStories_V1')) || [];
    let currentStory = null;
    let mainDB = null;

    // Load main app DB to check for duplicates
    try {
        mainDB = JSON.parse(localStorage.getItem('mandarinFinalSuite_V12')) || { words: [], groups: [] };
    } catch(e) { mainDB = { words: [], groups: [] }; }

    function init() {
        if(stories.length === 0) {
            document.getElementById('content-area').innerHTML = '<p style="color:#999; text-align:center;">No stories yet.<br>Click "Import Stories JSON" in the sidebar.</p>';
        } else {
            renderList();
            loadStory(0);
        }
    }

    function renderList() {
        const list = document.getElementById('story-list');
        list.innerHTML = '';
        stories.forEach((s, idx) => {
            const div = document.createElement('div');
            div.className = `story-item ${currentStory === idx ? 'active' : ''}`;
            div.innerText = s.title;
            div.onclick = () => loadStory(idx);
            list.appendChild(div);
        });
    }

    function loadStory(idx) {
        currentStory = idx;
        renderList();
        renderCurrent();
    }

    // --- 2. RENDER TEXT (Now with Smart Word Detection) ---
    function renderCurrent() {
        if(currentStory === null || !stories[currentStory]) return;
        const s = stories[currentStory];
        const showPinyin = document.getElementById('pinyin-toggle').checked;
        
        document.getElementById('story-title').innerText = s.title;
        const contentDiv = document.getElementById('content-area');
        contentDiv.innerHTML = '';
        contentDiv.className = showPinyin ? '' : 'hide-pinyin';

        // 1. Initialize the Smart Segmenter (Browser's built-in tool)
        // This splits text by "Words" instead of "Characters"
        const segmenter = new Intl.Segmenter('zh-CN', { granularity: 'word' });
        const segments = segmenter.segment(s.content);
        
        let html = '';

        // 2. Loop through the grouped words
        for (const seg of segments) {
            const word = seg.segment; // The actual word (e.g., "ÂñúÊ¨¢")
            
            // Check if it contains Chinese characters
            if(/[\u4e00-\u9fa5]/.test(word)) {
                // Get Pinyin for the WHOLE word
                // .replace is used to escape apostrophes safely
                const py = pinyinPro.pinyin(word);
                const safeWord = word.replace(/'/g, "\\'");
                const safePy = py.replace(/'/g, "\\'");
                
                html += `<ruby class="char-span" onclick="clickChar('${safeWord}', '${safePy}')">${word}<rt>${py}</rt></ruby>`;
            } else {
                // Punctuation or numbers (don't make clickable)
                html += `<span>${word}</span>`;
            }
        }

        contentDiv.innerHTML = html;
        
        // Show translation at bottom
        const transDiv = document.getElementById('story-translation');
        if(s.translation) {
            transDiv.style.display = 'block';
            transDiv.innerText = s.translation;
        } else { transDiv.style.display = 'none'; }
    }

    // --- 3. INTERACTIVITY ---
    let selectedChar = '';
    let selectedPinyin = '';
    let fetchedMeaning = '';

    async function clickChar(char, py) {
        const popup = document.getElementById('word-popup');
        selectedChar = char;
        selectedPinyin = py;
        
        document.getElementById('pop-char').innerText = char;
        document.getElementById('pop-pinyin').innerText = py;
        document.getElementById('pop-def').innerHTML = '<i>Searching dictionary...</i>';
        
        // Position Popup (Simple center for now, or near mouse if refined)
        popup.style.display = 'block';
        popup.style.top = '20%';
        popup.style.left = '50%';
        popup.style.transform = 'translate(-50%, 0)';

        // API Call (Same as main app)
        try {
            const r = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(char)}&langpair=zh-CN|en`);
            const d = await r.json();
            fetchedMeaning = d.responseData.translatedText;
            document.getElementById('pop-def').innerText = fetchedMeaning;
        } catch(e) {
            document.getElementById('pop-def').innerText = "Dictionary Error";
        }
    }

    function closePopup() { document.getElementById('word-popup').style.display = 'none'; }

    function saveToMainApp() {
        if(!selectedChar || !fetchedMeaning) return;
        
        // Check if exists
        const exists = mainDB.words.find(w => w.char === selectedChar);
        if(exists) { alert("Already in your library!"); return; }

        // Add to DB
        const newID = Date.now();
        mainDB.words.push({
            id: newID,
            char: selectedChar,
            pinyin: selectedPinyin,
            meaning: fetchedMeaning
        });

        // Add to a "Stories" Group automatically?
        // Let's create one if it doesn't exist
        let storyGroup = mainDB.groups.find(g => g.name === "From Stories");
        if(!storyGroup) {
            storyGroup = { id: 111, name: "From Stories", wordIds: [] };
            mainDB.groups.push(storyGroup);
        }
        storyGroup.wordIds.push(newID);

        // Save back to LocalStorage
        localStorage.setItem('mandarinFinalSuite_V12', JSON.stringify(mainDB));
        alert(`Saved "${selectedChar}" to Main Library!`);
        closePopup();
    }

    // --- 4. UTILS ---
    function speakStory() {
        const s = stories[currentStory];
        if(!s) return;
        const u = new SpeechSynthesisUtterance(s.content);
        u.lang = 'zh-CN';
        u.rate = 0.8; // Slower for learning
        window.speechSynthesis.speak(u);
    }

    function toggleTheme() {
        document.body.classList.toggle('dark');
    }

    function importStories(e) {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onload = (ev) => {
            try {
                const data = JSON.parse(ev.target.result);
                if(Array.isArray(data)) {
                    stories = data;
                    localStorage.setItem('mandarinStories_V1', JSON.stringify(stories));
                    init();
                    alert("Stories Imported!");
                }
            } catch(e) { alert("Invalid JSON"); }
        };
        reader.readAsText(file);
    }

    init();
</script>
</body>
</html>