<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smash Online üåé</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        body { margin: 0; background: #2c3e50; font-family: 'Segoe UI', sans-serif; color: white; display: flex; flex-direction: column; height: 100vh; text-align: center; user-select: none; overflow: hidden; }
        
        .screen { display: none; flex-direction: column; align-items: center; justify-content: center; height: 100%; padding: 20px; box-sizing: border-box; width: 100%; }
        .active { display: flex; }

        input, select { padding: 15px; font-size: 18px; border-radius: 8px; border: none; margin: 10px 0; width: 80%; max-width: 300px; text-align: center; }
        button { padding: 15px 30px; font-size: 18px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; margin: 10px; transition: 0.2s; }
        .btn-green { background: #27ae60; color: white; }
        .btn-blue { background: #2980b9; color: white; }
        .btn-red { background: #c0392b; color: white; }
        button:hover { transform: scale(1.05); }

        /* GAME UI */
        .q-card { background: white; color: #333; padding: 30px; border-radius: 12px; width: 100%; max-width: 500px; margin-bottom: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .q-text { font-size: 50px; font-family: "KaiTi"; margin: 0; }
        .q-count { font-size: 14px; color: #888; margin-bottom: 5px; text-transform: uppercase; }
        
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: 100%; max-width: 500px; }
        .ans-btn { height: 80px; font-size: 20px; color: white; text-shadow: 1px 1px 0 rgba(0,0,0,0.5); border: 4px solid transparent; transition: 0.2s; }
        .c-0 { background: #e74c3c; } .c-1 { background: #3498db; }
        .c-2 { background: #f1c40f; } .c-3 { background: #2ecc71; }

        /* ANSWER STATES */
        .ans-btn.reveal-correct { opacity: 1 !important; border-color: #fff; box-shadow: 0 0 15px #2ecc71; transform: scale(1.05); }
        .ans-btn.reveal-wrong { opacity: 0.4; }
        .ans-btn.clicked-wrong { border-color: #333; opacity: 1 !important; background: #555 !important; }

        /* LEADERBOARD */
        .lb-row { display: flex; justify-content: space-between; background: rgba(0,0,0,0.3); width: 100%; max-width: 400px; padding: 15px; margin: 5px 0; border-radius: 8px; font-size: 20px; font-weight: bold; }
        .lb-rank-1 { background: #f1c40f; color: #333; transform: scale(1.1); }
        .lb-rank-2 { background: #bdc3c7; color: #333; }
        .lb-rank-3 { background: #e67e22; }

        .player-list { text-align: left; background: rgba(0,0,0,0.2); padding: 20px; border-radius: 10px; width: 80%; max-width: 300px; max-height: 250px; overflow-y: auto; margin-bottom: 20px; }
        .p-row { display: flex; justify-content: space-between; border-bottom: 1px solid rgba(255,255,255,0.1); padding: 5px 0; }

        .lobby-settings { background: rgba(0,0,0,0.2); padding: 15px; border-radius: 10px; width: 90%; max-width: 350px; display: none; }
        .lobby-settings.visible { display: block; }

        /* FLOATING FEEDBACK */
        #float-feedback { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 100; pointer-events: none; }
        .big-icon { font-size: 100px; }
    </style>
</head>
<body>

<button onclick="window.location.href='index.html'" style="position:absolute; top:10px; left:10px; padding:5px 10px; font-size:14px; background:#333; color:fff;">üè† Home</button>

<!-- 1. SETUP SCREEN -->
<div id="screen-setup" class="screen active">
    <h1>Smash Online üåé</h1>
    <input type="text" id="p-name" placeholder="Your Name">
    
    <div style="background:rgba(255,255,255,0.1); padding:20px; border-radius:10px; margin-top:20px;">
        <h3>Host Game</h3>
        <button class="btn-blue" onclick="hostGame()">Create Room</button>
    </div>

    <div style="background:rgba(255,255,255,0.1); padding:20px; border-radius:10px; margin-top:20px;">
        <h3>Join Game</h3>
        <input type="text" id="room-code-input" placeholder="Room Code" style="text-transform: uppercase;">
        <button class="btn-green" onclick="joinGame()">Join Room</button>
    </div>
</div>

<!-- 2. LOBBY SCREEN -->
<div id="screen-lobby" class="screen">
    <h1 id="lobby-code" style="font-size: 60px; letter-spacing: 5px; color: #f1c40f; margin: 0;">----</h1>
    <p>Waiting for players...</p>
    <div class="player-list" id="lobby-list"></div>

    <div id="host-controls" class="lobby-settings">
        <label style="font-size:12px; color:#aaa; display:block; margin-top:5px;">Deck:</label>
        <select id="group-select-lobby" style="width:100%; margin:5px 0; padding:10px;"></select>
        
        <label style="font-size:12px; color:#aaa; display:block; margin-top:5px;">Speed:</label>
        <select id="time-select-lobby" style="width:100%; margin:5px 0; padding:10px;">
            <option value="10">10 Seconds (Normal)</option>
            <option value="20">20 Seconds (Easy)</option>
            <option value="5">5 Seconds (Hard)</option>
            <option value="3">3 Seconds (Chaos)</option>
        </select>
        
        <button class="btn-green" onclick="launchGameLoop()" style="width:100%; margin:10px 0;">üöÄ Launch Game</button>
    </div>

    <p id="msg-wait" style="display:none;">Host is configuring settings...</p>
</div>

<!-- 3. GAME SCREEN -->
<div id="screen-game" class="screen">
    <div style="display:flex; justify-content:space-between; width:100%; max-width:500px; margin-bottom:10px;">
        <span id="game-timer" style="font-size:24px; font-weight:bold;">‚è≥ 10</span>
        <span id="my-score">0 Pts</span>
    </div>
    
    <div class="q-card">
        <div class="q-count" id="q-counter">Question 1/10</div>
        <h2 class="q-text" id="q-char">...</h2>
    </div>

    <div class="grid">
        <button class="ans-btn c-0" onclick="sendAnswer(0)" id="btn-0"></button>
        <button class="ans-btn c-1" onclick="sendAnswer(1)" id="btn-1"></button>
        <button class="ans-btn c-2" onclick="sendAnswer(2)" id="btn-2"></button>
        <button class="ans-btn c-3" onclick="sendAnswer(3)" id="btn-3"></button>
    </div>
</div>

<!-- 4. LEADERBOARD SCREEN -->
<div id="screen-leaderboard" class="screen">
    <h1>Top Players</h1>
    <div id="lb-container" style="width:100%; display:flex; flex-direction:column; align-items:center;"></div>
    <p id="lb-timer" style="margin-top:20px; color:#aaa;">Next round coming up...</p>
</div>

<!-- 5. FINAL RESULTS SCREEN -->
<div id="screen-final" class="screen">
    <h1>üèÜ Game Over!</h1>
    <div id="final-podium" style="width:100%; display:flex; flex-direction:column; align-items:center;"></div>
    <button class="btn-blue" onclick="location.reload()" style="margin-top:30px;">Play Again</button>
</div>

<!-- FEEDBACK OVERLAY -->
<div id="float-feedback">
    <div class="big-icon" id="fb-icon">‚úÖ</div>
    <h2 id="fb-text">Correct!</h2>
    <h3 id="fb-points">+0</h3>
</div>

<script>
    // --- 1. FIREBASE CONFIG ---
    // ‚ö†Ô∏è REPLACE THIS BLOCK WITH YOUR KEY FROM GOOGLE ‚ö†Ô∏è
    const firebaseConfig = {
  apiKey: "AIzaSyDY6QN-GbW0JLfnQK1jU08Gf6zk0BuRtRw",
  authDomain: "mandarin-smash.firebaseapp.com",
  databaseURL: "https://mandarin-smash-default-rtdb.firebaseio.com",
  projectId: "mandarin-smash",
  storageBucket: "mandarin-smash.firebasestorage.app",
  messagingSenderId: "282254806408",
  appId: "1:282254806408:web:2ff34640121186ae2bfe3d",
  measurementId: "G-BHMZKHBYSF"
};
    
    firebase.initializeApp(firebaseConfig);
    const dbRef = firebase.database().ref();

    // --- STATE ---
    let myName = "";
    let myRoom = "";
    let myId = "";
    let isHost = false;
    let localDB = { words: [], groups: [] };
    let currentScore = 0;
    let roundStartTime = 0;
    let roundDuration = 10;
    let globalPlayerList = [];
    let visualTimerID = null; // Stores the timer ID so we can kill it
    let currentCorrectIndex = -1;
    
    // NEW: Track the Host's timer ID to kill it early
    let hostTimerID = null;

    // Load Local Dictionary
    try {
        const local = localStorage.getItem('mandarinFinalSuite_V12');
        if (local) localDB = JSON.parse(local);
        
        // TARGET THE LOBBY DROPDOWN NOW
        const sel = document.getElementById('group-select-lobby');
        sel.innerHTML = '<option value="all">üìö All Words</option>';
        localDB.groups.forEach(g => {
            if(g.wordIds.length >= 4) sel.innerHTML += `<option value="${g.id}">üìÅ ${g.name}</option>`;
        });
    } catch(e) {}

    // --- UI HELPERS ---
    function switchScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }

    function generateCode() { return Math.random().toString(36).substring(2, 6).toUpperCase(); }

    // --- HOST LOGIC (Simplified) ---
    function hostGame() {
        myName = document.getElementById('p-name').value || "Host";
        myRoom = generateCode();
        isHost = true;

        // Just create the room structure. 
        // We don't check settings/words here anymore (that happens in Launch).
        dbRef.child('rooms/' + myRoom).set({
            status: 'lobby',
            roundIndex: -1
        }).then(() => {
            const newPlayerRef = dbRef.child(`rooms/${myRoom}/players`).push();
            myId = newPlayerRef.key;
            newPlayerRef.set({ name: myName, score: 0 });
            enterLobby();
        });
    }

    // --- JOIN LOGIC ---
    function joinGame() {
        myName = document.getElementById('p-name').value || "Guest";
        myRoom = document.getElementById('room-code-input').value.toUpperCase().trim();
        isHost = false;

        dbRef.child('rooms/' + myRoom).once('value', snapshot => {
            if (snapshot.exists()) {
                const newPlayerRef = dbRef.child(`rooms/${myRoom}/players`).push();
                myId = newPlayerRef.key;
                newPlayerRef.set({ name: myName, score: 0 });
                enterLobby();
            } else { alert("Room not found!"); }
        });
    }

    function enterLobby() {
        switchScreen('screen-lobby');
        document.getElementById('lobby-code').innerText = myRoom;
        if(isHost) document.getElementById('host-controls').classList.add('visible');
        else document.getElementById('msg-wait').style.display = 'block';

        // Listen for Players
        dbRef.child(`rooms/${myRoom}/players`).on('value', snap => {
            const list = document.getElementById('lobby-list');
            list.innerHTML = '';
            globalPlayerList = [];
            snap.forEach(p => {
                const val = p.val();
                globalPlayerList.push(val);
                list.innerHTML += `<div class="p-row"><span>${val.name}</span><span>${val.score}</span></div>`;
            });
            if(document.getElementById('screen-leaderboard').classList.contains('active')) renderLeaderboard();
        });

        // Listen for Game Status
        dbRef.child(`rooms/${myRoom}/status`).on('value', snap => {
            const status = snap.val();
            if(status === 'playing') startRoundUI();
            if(status === 'leaderboard') showLeaderboardUI();
            if(status === 'finished') showFinalResults();
        });
        
        // Listen for Settings
        dbRef.child(`rooms/${myRoom}/settings`).on('value', snap => {
            if(snap.val()) roundDuration = snap.val().time;
        });
        
        // Listen for Round Data (Reset Feedback)
        dbRef.child(`rooms/${myRoom}/currentRound`).on('value', () => {
             // Reset UI buttons for next round
             document.querySelectorAll('.ans-btn').forEach(b => {
                 b.className = 'ans-btn'; // Remove correct/wrong classes
                 // Re-add colors logic is handled in startRoundUI
             });
        });
    }

    // --- GAME LOOP (HOST) ---
    function launchGameLoop() {
        roundDuration = parseInt(document.getElementById('time-select-lobby').value);
        const gid = document.getElementById('group-select-lobby').value;
        
        let pool = localDB.words;
        if(gid !== 'all') {
            const g = localDB.groups.find(x => x.id == gid);
            if(g) pool = pool.filter(w => g.wordIds.includes(w.id));
        }
        
        if(pool.length < 4) return alert("Not enough words!");
        pool.sort(() => Math.random() - 0.5);

        dbRef.child(`rooms/${myRoom}`).update({
            deck: pool,
            cardIndex: 0,
            settings: { time: roundDuration }
        }).then(() => nextQuestionHost());
    }

    function nextQuestionHost() {
        dbRef.child(`rooms/${myRoom}`).once('value', snap => {
            const data = snap.val();
            const deck = data.deck;
            const currentIndex = data.cardIndex;

            if(currentIndex >= deck.length) {
                dbRef.child(`rooms/${myRoom}`).update({ status: 'finished' });
                return;
            }
            
            const correctWord = deck[currentIndex];
            const distractors = deck.filter(w => w.id !== correctWord.id).sort(()=>0.5-Math.random()).slice(0, 3);
            const options = [correctWord, ...distractors].sort(()=>0.5-Math.random());
            const correctIdx = options.findIndex(o => o.id === correctWord.id);

            // Reset Answers Count
            dbRef.child(`rooms/${myRoom}/currentRound`).set({
                char: correctWord.char,
                options: options.map(o => o.meaning),
                correctIndex: correctIdx,
                currentNum: currentIndex + 1,
                totalNum: deck.length,
                startTime: Date.now(),
                answersCount: 0 // Reset counter
            });

            dbRef.child(`rooms/${myRoom}`).update({ status: 'playing', cardIndex: currentIndex + 1 });

            // Set Max Timeout
            if(hostTimerID) clearTimeout(hostTimerID);
            hostTimerID = setTimeout(endRoundByHost, (roundDuration + 2) * 1000);
            
            // Watch for All Answers (Auto-End)
            const roundRef = dbRef.child(`rooms/${myRoom}/currentRound/answersCount`);
            roundRef.off(); // Clear old listener
            roundRef.on('value', answerSnap => {
                const count = answerSnap.val() || 0;
                // Get player count
                const totalPlayers = globalPlayerList.length;
                if(count >= totalPlayers) {
                    // Everyone answered! End early.
                    roundRef.off();
                    if(hostTimerID) clearTimeout(hostTimerID);
                    
                    setTimeout(endRoundByHost, 2000);
                }
            });
        });
    }

    function endRoundByHost() {
        dbRef.child(`rooms/${myRoom}`).update({ status: 'leaderboard' });
        setTimeout(nextQuestionHost, 3000);
    }

    // --- GAME LOOP (CLIENT) ---
    function startRoundUI() {
        document.getElementById('float-feedback').style.display = 'none';
        switchScreen('screen-game');
        
        dbRef.child(`rooms/${myRoom}/currentRound`).once('value', snap => {
            const data = snap.val();
            document.getElementById('q-char').innerText = data.char;
            document.getElementById('q-counter').innerText = `Question ${data.currentNum} / ${data.totalNum}`;
            
            // --- NEW: Save the correct index for later ---
            currentCorrectIndex = data.correctIndex; 
            // ---------------------------------------------

            // Reset buttons
            const colors = ['c-0', 'c-1', 'c-2', 'c-3'];
            for(let i=0; i<4; i++) {
                const btn = document.getElementById(`btn-${i}`);
                btn.innerText = data.options[i];
                btn.disabled = false;
                btn.className = `ans-btn ${colors[i]}`; // Reset styling
            }
            roundStartTime = Date.now();
            startVisualTimer();
        });
    }

    function startVisualTimer() {
        if (visualTimerID) clearInterval(visualTimerID);

        let t = roundDuration;
        document.getElementById('game-timer').innerText = `‚è≥ ${t}`;
        
        visualTimerID = setInterval(() => {
            t--;
            document.getElementById('game-timer').innerText = `‚è≥ ${t}`;
            
            if(t <= 0) {
                clearInterval(visualTimerID);
                handleTimeout(); // Trigger the "Time's Up" effect
            }
        }, 1000);
    }

    // ADD THIS NEW FUNCTION RIGHT BELOW IT:
    function handleTimeout() {
        // 1. Disable buttons
        for(let i=0; i<4; i++) document.getElementById(`btn-${i}`).disabled = true;

        // 2. Reveal the correct answer (Green Glow)
        const colors = ['c-0', 'c-1', 'c-2', 'c-3'];
        if(currentCorrectIndex !== -1) {
            document.getElementById(`btn-${currentCorrectIndex}`).className = `ans-btn ${colors[currentCorrectIndex]} reveal-correct`;
        }

        // 3. Show "Time's Up" Overlay
        document.getElementById('fb-icon').innerText = "‚è∞";
        document.getElementById('fb-text').innerText = "Time's Up!";
        document.getElementById('fb-text').style.color = "#fff";
        document.getElementById('fb-points').innerText = "+0";
        
        const feedback = document.getElementById('float-feedback');
        feedback.style.display = 'flex';
        
        // Hide overlay after 1.5s (so they can see the green button behind it)
        setTimeout(() => { feedback.style.display = 'none'; }, 1500);
    }
    
    function sendAnswer(idx) {
        // Disable buttons
        for(let i=0; i<4; i++) document.getElementById(`btn-${i}`).disabled = true;

        // Fetch Round Info
        dbRef.child(`rooms/${myRoom}/currentRound`).once('value', snap => {
            const data = snap.val();
            
            // 1. Increment Answer Count (for Host Auto-End)
            dbRef.child(`rooms/${myRoom}/currentRound/answersCount`).transaction(count => (count || 0) + 1);

            // 2. Visual Feedback Logic
            const feedback = document.getElementById('float-feedback');
            const correctIdx = data.correctIndex;
            
            // Highlight Correct Answer (Always)
            const colors = ['c-0', 'c-1', 'c-2', 'c-3'];
            document.getElementById(`btn-${correctIdx}`).className = `ans-btn ${colors[correctIdx]} reveal-correct`;

            if(idx === correctIdx) {
                // Correct Logic
                const timeTaken = (Date.now() - roundStartTime) / 1000;
                const points = Math.max(100, Math.floor(1000 * (1 - (timeTaken / roundDuration))));
                currentScore += points;
                
                dbRef.child(`rooms/${myRoom}/players/${myId}`).update({ score: currentScore });

                document.getElementById('fb-icon').innerText = "üî•";
                document.getElementById('fb-text').innerText = "Correct!";
                document.getElementById('fb-text').style.color = "#2ecc71";
                document.getElementById('fb-points').innerText = `+${points} Pts`;
            } else {
                // Wrong Logic
                document.getElementById(`btn-${idx}`).className = `ans-btn clicked-wrong`; // Turn grey
                
                document.getElementById('fb-icon').innerText = "‚ùå";
                document.getElementById('fb-text').innerText = "Wrong!";
                document.getElementById('fb-text').style.color = "#e74c3c";
                document.getElementById('fb-points').innerText = "+0";
            }
            
            document.getElementById('my-score').innerText = `${currentScore} Pts`;
            
            // Show overlay briefly
            feedback.style.display = 'flex';
            setTimeout(() => { feedback.style.display = 'none'; }, 1500);
        });
    }

    function showLeaderboardUI() {
        document.getElementById('float-feedback').style.display = 'none';
        switchScreen('screen-leaderboard');
        renderLeaderboard();
    }

    function showFinalResults() {
        switchScreen('screen-final');
        const container = document.getElementById('final-podium');
        container.innerHTML = "";
        
        const sorted = [...globalPlayerList].sort((a, b) => b.score - a.score);
        sorted.forEach((p, idx) => {
            let medal = idx === 0 ? "ü•á" : (idx === 1 ? "ü•à" : (idx === 2 ? "ü•â" : ""));
            container.innerHTML += `
                <div class="lb-row" style="background:${idx===0?'#f1c40f':'rgba(0,0,0,0.3)'}">
                    <span>${medal} ${p.name}</span>
                    <span>${p.score}</span>
                </div>
            `;
        });
    }

    function renderLeaderboard() {
        const container = document.getElementById('lb-container');
        container.innerHTML = "";
        const sorted = [...globalPlayerList].sort((a, b) => b.score - a.score);
        sorted.forEach((p, idx) => {
            let rankClass = "";
            if(idx === 0) rankClass = "lb-rank-1";
            else if(idx === 1) rankClass = "lb-rank-2";
            else if(idx === 2) rankClass = "lb-rank-3";
            container.innerHTML += `
                <div class="lb-row ${rankClass}">
                    <span>#${idx+1} ${p.name}</span>
                    <span>${p.score}</span>
                </div>
            `;
        });
    }
</script>
</body>
</html>